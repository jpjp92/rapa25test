"""
Gemini 이미지 분석 프롬프트 v1.0
한국적 배경 및 객체 생성 데이터 분석

주요 기능:
    - 이미지 카테고리 분류 (LocationCategory, EraCategory)
    - 5개 설명문 생성 (정경, 색감, 구도, 객체1, 객체2)
    - 총 50어절 이상 검증
"""

from typing import Optional, Dict
from .categories import CATEGORY_DATA, CATEGORY_LABELS


def get_image_analysis_prompt(image_metadata: Optional[Dict] = None) -> str:
    """
    Gemini 이미지 분석 프롬프트 생성

    Args:
        image_metadata: 이미지 메타데이터
            - width: int
            - height: int
            - format: str
            - file_size: int

    Returns:
        프롬프트 문자열
    """

    # 카테고리 정보를 프롬프트용 텍스트로 변환
    categories_text = ""
    for key, items in CATEGORY_DATA.items():
        korean_name = CATEGORY_LABELS.get(key, key)
        labels = ", ".join([f"{item['label']}({item['class']})" for item in items])
        categories_text += f"- **{key}** ({korean_name}): {labels}\n"

    # 메타데이터 섹션
    metadata_section = ""
    if image_metadata:
        metadata_section = f"""
## 이미지 메타데이터 (정확한 정보 - 반드시 사용)
**이 정보는 실제 이미지에서 추출한 정확한 값입니다. 추측하지 말고 아래 값을 그대로 사용하세요:**
- **이미지 해상도**: {image_metadata['width']} × {image_metadata['height']} 픽셀
- **이미지 포맷**: {image_metadata['format']}
- **파일 크기**: {image_metadata['file_size']} bytes

**중요: 위 값들은 절대 변경하거나 추측하지 마세요. JSON 출력 시 그대로 사용하세요.**
"""

    # 전체 프롬프트
    prompt = f"""
이미지를 분석하여 다음 정보를 JSON으로 제공하세요:

{metadata_section}

## 분석 단계

### 1단계: 카테고리 분류 (category_info)

이미지를 보고 아래 카테고리에서 가장 적합한 label을 정확히 선택하세요:
{categories_text}

**카테고리 분류 규칙:**

1. **LocationCategory (장소 구분)**
   - 실내(1): 건물 내부, 방, 실내 공간
   - 실외(2): 야외, 자연, 거리, 건물 외부
   - 혼합(3): 실내와 실외가 함께 보이는 경우
  - 기타(4) : 일러스트나 애니메이션은 무조건 기타로 분류

2. **EraCategory (시대 구분)**
   - 현대(2): 현대 복장을 입은 모든 경우 (일상복, 정장, 캐주얼 등),일러스트나 애니메이션은 무조건 기타로 분류
   - 전통(1): 사극, 시대극 배경 (한복, 갑옷, 전통 의상 착용), 일러스트나 애니메이션은 무조건 기타로 분류
   - 혼합(3): 배경이 사극, 시대극에 현대물건이 있는 경우
   - 기타(4): 순수하게 자연물만 나오는 경우, 일러스트나 애니메이션은 무조건 기타로 분류


### 한국전통색상 사용 규칙 (EraCategory=1인 경우)

**EraCategory가 전통(1)으로 판정된 경우, ColortoneExp 작성 시 아래 한국전통표준색을 사용하세요:**

#### 주요 전통색상 (카테고리별):

**흑백 계열:**
- 흑색 (#1d1e23), 백색 (#ffffff), 회색 (#a4aaa7), 설백색 (#dde7e7)

**적·홍 계열:**
- 적색 (#b82647), 홍색 (#f15b5b), 주홍색 (#c23352), 진홍색 (#bf2f7b)
- 연지색 (#be577b), 분홍색 (#e2a6b4), 갈색 (#966147)

**자 계열:**
- 자색 (#6d1b43), 자주색 (#89236a), 보라색 (#9c4998), 포도색 (#5d3462)

**청·벽·녹 계열:**
- 청색 (#0b6db7), 벽색 (#00b5e3), 옥색 (#9ed6c0), 비색 (#72c6a5)
- 청록색 (#009770), 녹색 (#417141), 연두색 (#c0d84d)

**황 계열:**
- 황색 (#f9d537), 송화색 (#f8e77f), 치자색 (#f6cf7a), 금색 (황색 계열)

**전통색상 사용 지침:**
1. 이미지의 주요 색상을 위 RGB 코드와 비교하여 가장 가까운 전통색상명 선택
2. "색상명 + 대상" 형식으로 작성 (예: "옥색 치마", "적색 댕기", "송화색 저고리")
3. 전통색상명을 사용하되, 너무 어색한 경우 기본 색상 표현도 가능
4. 전체적인 색감 조화는 전통색상을 우선 사용하여 표현

**예시:**
- "옥색 치마와 송화색 저고리가 조화를 이루는 전통적 색감이다."
- "짙은 자주색 한복과 금색 장식이 어우러진 고풍스러운 색감이다."
- "적색 댕기와 백색 저고리가 대비를 이루는 선명한 색감이다."


### 2단계: 설명문 작성 (annotation_info)

**전달하는 이미지를 생성하기 위한 INPUT 설명문을 아래 기준을 참고해서 만들어주세요.**

#### 총 5문장 작성:

1. **장면 설명 (SceneExp)**
   - **목적**: 이미지의 전체적인 맥락과 상황 전달. 색감은 제외
   - **포함 요소**: 장소의 종류, 전체적인 환경, 사람들의 행동/상황
   - **제외 요소**: 색상(ColortoneExp), 카메라 각도(CompositionExp), 개별 객체 세부사항(ObjectExp)
   - **작성 방식**: 구체적인 장소, 환경, 행동 중심으로 묘사 (추상적 분위기 표현 최소화)
   - **중복 주의**: 색감 설명과 동일한 수식어 사용 금지 (차분한, 밝은, 어두운, 활기찬, 따뜻한 등)
   - 종결 어미: **~장면이다.**

2. **색감 설명 (ColortoneExp)**
   - **목적**: 이미지의 색채적 특성만 전달
   - **포함 요소**: 주요 색상, 색의 조화, 명암, 톤, 채도
   - **작성 방식**: "색상 + 대상"을 2-3개 조합하여 전체 색감 묘사
     - 예: "옅은 베이지색 벽", "푸른빛이 도는 하늘", "어두운 의상"
   - **조화 표현**: "어우러진", "조화를 이루는", "대비를 이루며" 등 사용
   - **제외 요소**: 객체의 형태나 질감, 장면의 분위기, 카메라 구도
   - **중요**: EraCategory가 전통(1)인 경우, 위 "한국전통색상 사용 규칙"을 참고하여 전통색상명 사용
   - 종결 어미: **~색감이다.**

3. **구도 설명 (CompositionExp)**
   - **목적**: 카메라 촬영 방식과 화면 구성만 전달
   - **포함 요소**: 카메라 높이(눈높이/높은 시점/낮은 시점), 각도(정면/측면/위/아래), 샷 크기(클로즈업/미디엄/와이드), 화면 배치
   - **제외 요소**: 색상, 객체의 세부 묘사, 장면의 내용 (배경에 무엇이 있다는 등)
   - **작성 방식**: 카메라 기술 용어 사용 (시점, 앵글, 샷 크기 등)
   - 종결 어미: **~구도이다.**

4. **객체1 설명 (ObjectExp1)**
   - **목적**: 이미지의 주요 객체 하나에 대한 물리적 특징 전달
   - **포함 요소**: 형태, 크기, 질감, 패턴, 자세, 동작, 의상/구조
   - **절대 금지**: 색상 표현 (빨간, 파란, 노란, 흰, 검은, 회색, 베이지, 밝은, 어두운 등)
   - **제외 요소**: 전체적 분위기(SceneExp), 카메라 구도
   - **동작 묘사 원칙**: 이미지에서 명확히 관찰되는 자세/동작만 기술 (추측 금지)
     - ✅ 허용: "서 있다", "앉아 있다", "입을 벌리고 있다", "팔을 들어 올리고 있다"
     - ❌ 금지: "사과를 수확하고 있다" (추측), "과일을 든 채" (불명확)
   - **객체가 사람인 경우 수 표현 규칙:**
     - 1-4명: 정확한 수 명시 (한 명, 두 명, 세 명, 네 명)
     - 5명 이상 또는 불명확: "여러 명", "다수의", "몇몇" 등 사용
   - 객체가 사물인 경우 표면적 느낌도 같이 설명
   - 종결 어미: **~다.**

5. **객체2 설명 (ObjectExp2)**
   - **목적**: 이미지의 또 다른 주요 객체에 대한 물리적 특징 전달
   - **포함 요소**: 형태, 크기, 질감, 패턴, 자세, 동작, 의상/구조
   - **절대 금지**: 색상 표현 (빨간, 파란, 노란, 흰, 검은, 회색, 베이지, 밝은, 어두운 등)
   - **제외 요소**: 전체적 분위기(SceneExp), 카메라 구도, 객체1과 중복되는 객체
   - **동작 묘사 원칙**: 이미지에서 명확히 관찰되는 자세/동작만 기술 (추측 금지)
     - ✅ 허용: "서 있다", "앉아 있다", "손을 뻗고 있다", "고개를 돌리고 있다"
     - ❌ 금지: "작업하고 있다" (모호함), "물건을 들고 있다" (불명확)
   - **객체가 사람인 경우 수 표현 규칙:**
     - 1-4명: 정확한 수 명시 (한 명, 두 명, 세 명, 네 명)
     - 5명 이상 또는 불명확: "여러 명", "다수의", "몇몇" 등 사용
   - 객체가 사물인 경우 표면적 느낌도 같이 설명
   - 종결 어미: **~다.**

#### 주의사항:

1. **객체 중복 금지**
   - 객체1과 객체2는 서로 다른 객체를 설명해야 함
   - 예: 객체1에서 "사람들"을 설명했으면, 객체2는 "건물" 등 다른 객체

2. **내용 중복 금지**
   - 5문장을 합쳐 한 문단으로 보고, 각 설명문에 포함되어야 할 내용을 중복 사용하지 말 것
   - 장면 설명에서 언급한 내용을 색감 설명에서 반복하지 말 것

3. **자막 및 방송 UI 요소 제외**
   - 자막, 방송 로고, 워터마크, 타임스탬프 등 방송/편집 요소는 설명하지 말 것
   - 화면에 표시된 텍스트 내용뿐만 아니라 UI 요소의 존재 자체도 언급하지 말 것
   - 제외 대상: 방송 로고, 프로그램명, 자막, 워터마크, 시간 표시 등
   - 올바른 예: "배경에는 나무 구조물과 옅은 베이지색 벽이 흐릿하게 보인다."
   - 잘못된 예: "화면 상단에는 방송 로고와 자막이 선명하게 나타난다."

4. **간결하고 명료하게**
   - 문장은 수식어가 너무 많지 않고 간단 명료하게 작성
   - 객체 설명문 1개당 1개의 객체에 대해서만 설명

5. **사람 수 표현 규칙 (매우 중요!)**
   - **1-4명인 경우**: 이미지를 자세히 보고 정확한 수를 세어 명시
     - 올바른 예: "세 명의 손님들이 카운터에 앉아 있다" (실제 3명)
     - 잘못된 예: "두 명의 손님들이 앉아 있다" (실제 3명인데 2명으로 잘못 셈)
   - **5명 이상이거나 정확히 세기 어려운 경우**: "여러 명", "다수의", "몇몇" 등 사용
     - 올바른 예: "여러 명의 여성들이 요트 위에서 포즈를 취하고 있다" (5명 이상)
     - 잘못된 예: "여섯 명의 여성들이..." (실제로는 5명인데 6명으로 잘못 셈)
   - **배경에 있거나 부분적으로 가려진 사람은 세지 않음**

6. **총 50어절 이상 (필수!)**
   - 5개 설명문을 모두 합쳤을 때 총 어절 수가 50어절 이상이어야 함
   - 어절은 띄어쓰기로 구분되는 단위
   - 예: "저는 오늘 사과를 먹었습니다." → 4어절 (저는 | 오늘 | 사과를 | 먹었습니다.)

#### 어절 수 검증 규칙:

**어절 정의:**
- 어절은 띄어쓰기로 구분되는 단위입니다.

**필수 조건:**
- **5개 문장의 총 어절 수 ≥ 50어절**

**검증 절차:**
1. 5개 description을 모두 작성
2. 각 문장의 어절 수 계산 (띄어쓰기 기준)
3. 총 어절 수 합산
4. **총 어절 수 < 50** → 각 문장에 구체적인 세부 묘사 추가

**어절 부족 시 보완 방법:**

**우선순위: 장면 > 객체1, 객체2 > 색감, 구도 순서로 구체화**

1. **장면 (SceneExp) - 우선 보완**
   - 부족: "해변과 건물이 보이는 장면이다." (5어절)
   - 충분: "넓은 해변이 곧게 펼쳐지고 그 뒤로 고층 건물들이 줄지어 서 있는 장면이다." (13어절)

2. **객체1, 객체2 - 다음 보완**
   - 부족: "사람들이 걷고 있다." (3어절)
   - 충분: "해변 곳곳에는 사람들이 여유롭게 걸으며 휴식을 즐기고 있다." (9어절)

3. **색감, 구도 - 간결하게 유지**
   - 색감: "밝은 모래빛과 짙푸른 바다가 어우러진 명료한 색감이다." (8어절)
   - 구도: "높은 시점에서 내려다보는 항공 구도이다." (6어절)



## 최종 출력 전 필수 검증

**자동 계산 검증:**
1.  이미지 메타데이터가 정확히 입력되었는가?
   - width, height, format 확인

**논리적 검증:**
1.  category_info의 LocationCategory와 EraCategory가 정확히 선택되었는가?
   - 이미지 내용과 일치하는지 확인

2.  annotation_info의 5개 설명문이 모두 작성되었는가?
   - SceneExp, ColortoneExp, CompositionExp, ObjectExp1, ObjectExp2

3.  객체1과 객체2가 중복되지 않는가?

4.  총 어절 수가 50어절 이상인가?
   - 5개 문장의 description을 모두 합쳐 띄어쓰기 기준으로 어절 수 계산
   - 총 어절 수 < 50 → 각 문장에 구체적 세부 묘사 추가 후 다시 계산
   - 총 어절 수 ≥ 50 → 통과

5.  Explanation이 5개 문장을 순서대로 합친 것인가?
   - SceneExp + ColortoneExp + CompositionExp + ObjectExp1 + ObjectExp2

**위 검증을 통과하지 못하면 처음부터 다시 분석!**


## 출력 형식

**중요:**
1. 모든 메타데이터 값은 제공된 값 그대로 사용
2. 아래 예시는 샘플이며, 반드시 실제 분석 결과로 교체
3. category_info는 딕셔너리 형태로 LocationCategory와 EraCategory의 class 번호만 출력

{{
  "meta": {{
    "width": [자동 생성],
    "height": [자동 생성],
    "format": "[자동 생성]"
  }},
  "category_info": {{
    "LocationCategory": 2,
    "EraCategory": 2
  }},
  "annotation_info": {{
    "SceneExp": "[실제 장면 설명으로 교체 - 장소, 환경, 분위기]",
    "ColortoneExp": "[실제 색감 설명으로 교체 - 색상, 명암, 톤]",
    "CompositionExp": "[실제 구도 설명으로 교체 - 카메라 각도, 원근감]",
    "ObjectExp1": "[실제 객체1 설명으로 교체 - 형태, 질감, 동작 (색상 제외)]",
    "ObjectExp2": "[실제 객체2 설명으로 교체 - 형태, 질감, 동작 (색상 제외)]",
    "Explanation": "[위 5개 설명을 순서대로 합친 전체 설명문]"
  }}
}}
"""

    return prompt


if __name__ == "__main__":
    # 테스트
    metadata = {
        'width': 1920,
        'height': 1080,
        'format': 'JPG',
        'file_size': 2048576
    }

    prompt = get_image_analysis_prompt(metadata)
    print(prompt)
